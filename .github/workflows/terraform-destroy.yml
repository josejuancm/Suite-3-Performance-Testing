name: 'Terraform Destroy'

on:
  workflow_dispatch:
    inputs:
      location:
        description: 'Azure Region'
        required: true
        default: 'westus'
      prefix:
        description: 'Resource Prefix'
        required: true
        default: 'jar'
      label:
        description: 'Environment Label'
        required: true
        default: 'ods-perf-test'
      environment:
        description: 'Environment to destroy'
        required: true
        type: environment
        default: 'develop'

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    defaults:
      run:
        working-directory: ./eng/terraform
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Azure Login
      run: |
        echo "ğŸ” Authenticating with Azure..."
        az login --service-principal \
          --username "$ARM_CLIENT_ID" \
          --password "$ARM_CLIENT_SECRET" \
          --tenant "$ARM_TENANT_ID"
        
        echo "Setting subscription..."
        az account set --subscription "$ARM_SUBSCRIPTION_ID"
        
        echo "âœ… Azure authentication successful"
      working-directory: ./eng/terraform

    - name: Create backend.tf
      run: |
        # Calculate the same state file name as used in deploy
        STATE_FILE="${{ inputs.prefix }}-${{ inputs.label }}.tfstate"
        RESOURCE_GROUP="${{ inputs.prefix }}-${{ inputs.label }}"
        
        # Get the storage account name
        STORAGE_ACCOUNT=$(az storage account list --resource-group ${RESOURCE_GROUP} --query "[0].name" -o tsv)
        
        # Create the backend configuration
        cat > backend.tf << EOF
        terraform {
          backend "azurerm" {}
        }
        EOF
        
        echo "Created backend.tf for Azure storage"
      working-directory: ./eng/terraform

    - name: Validate State File
      run: |
        # Calculate the same state file name as used in deploy
        STATE_FILE="${{ inputs.prefix }}-${{ inputs.label }}.tfstate"
        RESOURCE_GROUP="${{ inputs.prefix }}-${{ inputs.label }}"
        
        echo "ğŸ” Validating state file details:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Resource Group: ${RESOURCE_GROUP}"
        echo "Container: tfstate"
        echo "State Key: ${STATE_FILE}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # List available storage accounts in the resource group
        echo "ğŸ“¦ Available storage accounts in resource group:"
        STORAGE_ACCOUNTS=$(az storage account list --resource-group ${RESOURCE_GROUP} --query "[].name" -o tsv) || {
          echo "âŒ Failed to list storage accounts. Make sure the resource group exists."
          exit 1
        }
        
        # Find storage account with 'tfstate' in the name
        STORAGE_ACCOUNT=$(echo "$STORAGE_ACCOUNTS" | grep 'tfstate' || echo "")
        
        if [ -z "$STORAGE_ACCOUNT" ]; then
          echo "âŒ No tfstate storage account found in resource group ${RESOURCE_GROUP}"
          echo "Available storage accounts:"
          echo "$STORAGE_ACCOUNTS"
          exit 1
        fi
        
        echo "Using storage account: ${STORAGE_ACCOUNT}"
        
        # Initialize Terraform with the correct backend config
        terraform init -backend=true \
          -backend-config="resource_group_name=${RESOURCE_GROUP}" \
          -backend-config="storage_account_name=${STORAGE_ACCOUNT}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=${STATE_FILE}"
        
        # Try to show state
        if terraform show > /dev/null 2>&1; then
          echo "âœ… State file accessed successfully!"
          echo "ğŸ“‹ Current state contents:"
          terraform show
          
          echo -e "\nğŸ“‘ Resources in state:"
          terraform state list || echo "No resources found in state"
        else
          echo "âŒ Failed to access state file"
          echo "Please verify your backend configuration and permissions"
          exit 1
        fi

    - name: Create terraform.tfvars
      run: |
        cat > terraform.tfvars << EOF
        location="${{ inputs.location }}"
        prefix="${{ inputs.prefix }}"
        label="${{ inputs.label }}"
        web_vm_size="${{ vars.WEB_VM_SIZE }}"
        runner_vm_size="${{ vars.RUNNER_VM_SIZE }}"
        web_vm_image_publisher="${{ vars.WEB_VM_IMAGE_PUBLISHER }}"
        web_vm_image_offer="${{ vars.WEB_VM_IMAGE_OFFER }}"
        web_vm_image_sku="${{ vars.WEB_VM_IMAGE_SKU }}"
        sql_vm_size="${{ vars.SQL_VM_SIZE }}"
        sql_vm_image_publisher="${{ vars.SQL_VM_IMAGE_PUBLISHER }}"
        sql_vm_image_offer="${{ vars.SQL_VM_IMAGE_OFFER }}"
        sql_vm_image_sku="${{ vars.SQL_VM_IMAGE_SKU }}"
        web_admin_username="${{ secrets.WEB_ADMIN_USERNAME }}"
        web_admin_password="${{ secrets.WEB_ADMIN_PASSWORD }}"
        runner_admin_username="${{ secrets.RUNNER_ADMIN_USERNAME }}"
        runner_admin_password="${{ secrets.RUNNER_ADMIN_PASSWORD }}"
        sql_admin_username="${{ secrets.SQL_ADMIN_USERNAME }}"
        sql_admin_password="${{ secrets.SQL_ADMIN_PASSWORD }}"
        EOF
      working-directory: ./eng/terraform

    - name: Terraform Destroy
      run: |
        # Verify tfvars exists
        if [ ! -f "terraform.tfvars" ]; then
          echo "âŒ terraform.tfvars file is missing!"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        
        echo "ğŸ“‹ Current terraform.tfvars contents:"
        cat terraform.tfvars
        
        # First try to remove the VM extension
        echo "Attempting to remove VM extension..."
        terraform state rm module.runner_config.azurerm_virtual_machine_extension.script_install || true
        
        # Now attempt the destroy
        echo "Starting terraform destroy..."
        terraform destroy -auto-approve -var-file=terraform.tfvars -parallelism=1
      id: destroy
      continue-on-error: true
      working-directory: ./eng/terraform

    - name: Handle Destroy Failure
      if: steps.destroy.outcome == 'failure'
      run: |
        echo "Terraform destroy failed. Attempting recovery..."
        
        # Verify tfvars exists again
        if [ ! -f "terraform.tfvars" ]; then
          echo "âŒ terraform.tfvars file is missing in recovery step!"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        
        # List current state
        echo "Current state resources:"
        terraform state list || true
        
        # Try to remove problematic resources from state
        echo "Attempting to remove problematic resources from state..."
        terraform state list | grep "azurerm_virtual_machine_extension" | while read resource; do
          echo "Removing $resource from state..."
          terraform state rm "$resource" || true
        done
        
        # Try destroy again
        echo "Attempting destroy again..."
        terraform destroy -auto-approve -var-file=terraform.tfvars -parallelism=1
      working-directory: ./eng/terraform

    - name: Terraform Destroy Status
      if: steps.destroy.outcome == 'failure'
      run: |
        echo "Terraform destroy failed. Checking state..."
        terraform show
        exit 1
      working-directory: ./eng/terraform